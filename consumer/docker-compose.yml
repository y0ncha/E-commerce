# Consumer (Order Service) - Kafka message consumer
#
# SHARED BRIDGE NETWORK APPROACH: Uses kafka-shared-net bridge network
#
# How it works:
#   - Both Producer and Consumer define 'kafka-shared-net' with 'name: kafka-shared-net'
#   - Either compose file can be started first (idempotent configuration)
#   - Consumer connects directly to kafka:9092 via the shared bridge network
#   - Works in standalone mode (Kafka unavailable) and integrated mode (Kafka available)
#
# DEPLOYMENT:
#   docker compose up -d
#
# STANDALONE MODE: Consumer starts without producer, API works, Kafka unavailable
# INTEGRATED MODE: Start producer first, then consumer, full Kafka connectivity
#
# PORTS:
#   8082  - Order Service (Consumer API)

services:
  # Order Service (Consumer) - Processes order events from Kafka
  order-service:
    image: y0ncha/eda-consumer:2.0.0
    container_name: order-service
    ports:
      - "8082:8082"  # Consumer API
    environment:
      # Connect to Kafka via shared bridge network (kafka-shared-net)
      # Uses service name 'kafka' which resolves via Docker DNS
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_KAFKA_CONSUMER_GROUP_ID: order-service-group
      KAFKA_TOPIC: orders
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_MTA_EDA_CONSUMER: DEBUG
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8082/order-service/health/live" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - kafka-shared-net
    restart: unless-stopped

# Shared bridge network for connecting to Kafka
# Must match the network defined in producer/docker-compose.yml
networks:
  kafka-shared-net:
    name: kafka-shared-net
    driver: bridge
    external: false
