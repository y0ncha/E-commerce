# Consumer (Order Service) - Kafka message consumer
#
# This compose file includes:
#   - Order Service (Consumer): Consumes order events from Kafka
#
# REQUIRED SETUP:
#   Producer MUST be started first to create the 'producer_ecommerce-network'
#   Start Producer: cd ../producer && docker compose up -d
#   Start Consumer: cd ../consumer && docker compose up -d
#
# NETWORK CONNECTIVITY:
#   - Consumer connects to 'producer_ecommerce-network' (external network)
#   - Network created and managed by producer
#   - Consumer can resolve 'kafka:29092' via Docker DNS
#   - Both services share the same Kafka broker
#
# PORTS:
#   8082  - Order Service (Consumer API)

services:
  # Order Service (Consumer) - Processes order events from Kafka
  order-service:
    image: y0ncha/eda-consumer:2.0.0
    container_name: order-service
    ports:
      - "8082:8082"  # Consumer API
    environment:
      # Connect to Kafka in Producer's network using service name
      # When connected to producer_ecommerce-network: resolves to Kafka broker
      # When standalone: DNS won't resolve but app still starts (autoStartup=false)
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      SPRING_KAFKA_CONSUMER_GROUP_ID: order-service-group
      KAFKA_TOPIC: orders
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_MTA_EDA_CONSUMER: DEBUG
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8082/order-service/health/live" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: on-failure:2
    networks:
      - producer_ecommerce-network

networks:
  producer_ecommerce-network:
    external: true
    # Connects to the producer's network that contains Kafka
    # Producer must be started first: cd ../producer && docker compose up -d
