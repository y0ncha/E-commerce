# Consumer (Order Service) - Kafka message consumer
#
# SIMPLE APPROACH: Uses host.docker.internal to access Kafka
#
# How it works:
#   - Producer exposes Kafka on localhost:9092 (PLAINTEXT_HOST listener)
#   - Consumer connects via host.docker.internal:9092
#   - No need to join producer's network!
#   - Works in standalone mode (Kafka unavailable) and integrated mode (Kafka available)
#
# DEPLOYMENT:
#   docker compose up -d
#
# STANDALONE MODE: Consumer starts without producer, API works, Kafka unavailable
# INTEGRATED MODE: Start producer first, then consumer, full Kafka connectivity
#
# PORTS:
#   8082  - Order Service (Consumer API)

services:
  # Order Service (Consumer) - Processes order events from Kafka
  order-service:
    image: y0ncha/eda-consumer:2.0.0
    container_name: order-service
    ports:
      - "8082:8082"  # Consumer API
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Map to host machine IP
    environment:
      # Connect to Kafka via host machine's exposed port (localhost:9092)
      # host.docker.internal resolves to host machine IP from container
      # Works without joining producer's network!
      SPRING_KAFKA_BOOTSTRAP_SERVERS: host.docker.internal:9092
      SPRING_KAFKA_CONSUMER_GROUP_ID: order-service-group
      KAFKA_TOPIC: orders
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_MTA_EDA_CONSUMER: DEBUG
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8082/order-service/health/live" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped
