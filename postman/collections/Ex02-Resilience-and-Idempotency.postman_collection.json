{
	"info": {
		"_postman_id": "resilience-idempotency-ex02",
		"name": "Ex02 - Resilience and Idempotency Tests",
		"description": "Exercise 2 test suite focusing on resilience patterns and idempotent message processing.\n\nTests covered:\n- Broker availability checks\n- Idempotent duplicate orderId handling\n- Error handling for broker unavailability\n\nPrerequisites:\n- Producer and Consumer services running\n- Kafka broker running\n- EDA-Local environment configured",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Setup - Health Check Producer",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Producer service is alive\", () => {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"Producer Kafka connection is UP\", () => {",
							"    const jsonData = pm.response.json();",
							"    const kafkaCheck = jsonData.checks.kafka;",
							"    pm.expect(kafkaCheck.status).to.eql(\"UP\");",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{base_url_producer}}/health/ready",
					"host": ["{{base_url_producer}}"],
					"path": ["health", "ready"]
				},
				"description": "Verify Producer service and Kafka broker are available before running tests."
			},
			"response": []
		},
		{
			"name": "Setup - Health Check Consumer",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Consumer service is alive\", () => {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"Consumer Kafka connection is UP\", () => {",
							"    const jsonData = pm.response.json();",
							"    const kafkaCheck = jsonData.checks.kafka;",
							"    pm.expect(kafkaCheck.status).to.eql(\"UP\");",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{base_url_consumer}}/health/ready",
					"host": ["{{base_url_consumer}}"],
					"path": ["health", "ready"]
				},
				"description": "Verify Consumer service and Kafka connection are available before running tests."
			},
			"response": []
		},
		{
			"name": "Test 1.1 - Create Order (First Time)",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Generate a unique hex orderId for idempotency testing",
							"function generateHexId(length) {",
							"    let result = '';",
							"    const characters = '0123456789ABCDEF';",
							"    const charactersLength = characters.length;",
							"    for (let i = 0; i < length; i++) {",
							"        result += characters.charAt(Math.floor(Math.random() * charactersLength));",
							"    }",
							"    return result;",
							"}",
							"",
							"// Store orderId for reuse in idempotency test",
							"const orderId = generateHexId(16);",
							"pm.environment.set(\"test_order_id_idempotency\", orderId);",
							"console.log(\"Generated orderId for idempotency test:\", orderId);"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Order created successfully (201 Created)\", () => {",
							"    pm.response.to.have.status(201);",
							"});",
							"",
							"pm.test(\"Response contains order details\", () => {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property(\"order\");",
							"    pm.expect(jsonData.order.orderId).to.eql(pm.environment.get(\"test_order_id_idempotency\"));",
							"    pm.expect(jsonData.order.status).to.eql(\"CREATED\");",
							"});",
							"",
							"// Wait for consumer to process",
							"setTimeout(() => {}, 500);"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"orderId\": \"{{test_order_id_idempotency}}\",\n    \"numItems\": 3\n}"
				},
				"url": {
					"raw": "{{base_url_producer}}/create-order",
					"host": ["{{base_url_producer}}"],
					"path": ["create-order"]
				},
				"description": "Create an order for the first time. This establishes the baseline for idempotency testing."
			},
			"response": []
		},
		{
			"name": "Test 1.2 - Verify Order in Consumer",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Consumer processed order (200 OK)\", () => {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"Order details are correct\", () => {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData.orderId).to.eql(pm.environment.get(\"test_order_id_idempotency\"));",
							"    pm.expect(jsonData.status).to.eql(\"CREATED\");",
							"    pm.expect(jsonData).to.have.property(\"shippingCost\");",
							"    pm.expect(parseFloat(jsonData.shippingCost)).to.be.above(0);",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"orderId\": \"{{test_order_id_idempotency}}\"\n}"
				},
				"url": {
					"raw": "{{base_url_consumer}}/order-details",
					"host": ["{{base_url_consumer}}"],
					"path": ["order-details"]
				},
				"description": "Verify that the Consumer successfully processed and stored the order with calculated shipping cost."
			},
			"response": []
		},
		{
			"name": "Test 2.1 - Idempotency: Duplicate Create Order (Same orderId)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Producer will reject duplicate orderId with 409 Conflict",
							"pm.test(\"Producer rejects duplicate orderId (409 Conflict)\", () => {",
							"    pm.response.to.have.status(409);",
							"});",
							"",
							"pm.test(\"Error message indicates duplicate order\", () => {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData.error).to.eql(\"Conflict\");",
							"    pm.expect(jsonData.message).to.include(\"already exists\");",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"orderId\": \"{{test_order_id_idempotency}}\",\n    \"numItems\": 5\n}"
				},
				"url": {
					"raw": "{{base_url_producer}}/create-order",
					"host": ["{{base_url_producer}}"],
					"path": ["create-order"]
				},
				"description": "Test idempotency: Attempt to create an order with the same orderId. Producer should reject with 409 Conflict."
			},
			"response": []
		},
		{
			"name": "Test 2.2 - Verify Consumer State Unchanged",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Consumer state remains unchanged (200 OK)\", () => {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"Order details are unchanged (still 3 items from original)\", () => {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData.orderId).to.eql(pm.environment.get(\"test_order_id_idempotency\"));",
							"    pm.expect(jsonData.status).to.eql(\"CREATED\");",
							"    // Verify shipping cost matches original (3 items)",
							"    pm.expect(jsonData.items).to.have.lengthOf(3);",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"orderId\": \"{{test_order_id_idempotency}}\"\n}"
				},
				"url": {
					"raw": "{{base_url_consumer}}/order-details",
					"host": ["{{base_url_consumer}}"],
					"path": ["order-details"]
				},
				"description": "Verify Consumer state is unchanged after duplicate create attempt. Order should still have 3 items (original request)."
			},
			"response": []
		},
		{
			"name": "Test 3.1 - Idempotency: Duplicate Update (Same Status)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Update accepted by Producer (200 OK)\", () => {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"Producer publishes status update\", () => {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData.order.status).to.eql(\"CONFIRMED\");",
							"});",
							"",
							"// Wait for consumer to process",
							"setTimeout(() => {}, 500);"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "PUT",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"orderId\": \"{{test_order_id_idempotency}}\",\n    \"status\": \"CONFIRMED\"\n}"
				},
				"url": {
					"raw": "{{base_url_producer}}/update-order",
					"host": ["{{base_url_producer}}"],
					"path": ["update-order"]
				},
				"description": "Update order status to CONFIRMED (valid transition from CREATED)."
			},
			"response": []
		},
		{
			"name": "Test 3.2 - Verify Consumer Processed Update",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Consumer reflected status update (200 OK)\", () => {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"Order status is CONFIRMED\", () => {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData.status).to.eql(\"CONFIRMED\");",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"orderId\": \"{{test_order_id_idempotency}}\"\n}"
				},
				"url": {
					"raw": "{{base_url_consumer}}/order-details",
					"host": ["{{base_url_consumer}}"],
					"path": ["order-details"]
				},
				"description": "Verify Consumer processed the status update to CONFIRMED."
			},
			"response": []
		},
		{
			"name": "Test 3.3 - Idempotency: Send Duplicate Update (Same Status)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Producer accepts duplicate update (200 OK)\", () => {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"// Producer publishes the event again",
							"// Consumer should handle idempotently (skip if exact duplicate)",
							"setTimeout(() => {}, 500);"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "PUT",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"orderId\": \"{{test_order_id_idempotency}}\",\n    \"status\": \"CONFIRMED\"\n}"
				},
				"url": {
					"raw": "{{base_url_producer}}/update-order",
					"host": ["{{base_url_producer}}"],
					"path": ["update-order"]
				},
				"description": "Send the same status update again. Consumer should handle idempotently (At-Least-Once semantics)."
			},
			"response": []
		},
		{
			"name": "Test 3.4 - Verify Consumer Handled Duplicate Idempotently",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Consumer state unchanged by duplicate (200 OK)\", () => {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"Order status still CONFIRMED (idempotent processing)\", () => {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData.status).to.eql(\"CONFIRMED\");",
							"    pm.expect(jsonData.orderId).to.eql(pm.environment.get(\"test_order_id_idempotency\"));",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"orderId\": \"{{test_order_id_idempotency}}\"\n}"
				},
				"url": {
					"raw": "{{base_url_consumer}}/order-details",
					"host": ["{{base_url_consumer}}"],
					"path": ["order-details"]
				},
				"description": "Verify Consumer handled the duplicate update idempotently. Status should remain CONFIRMED with no corruption."
			},
			"response": []
		},
		{
			"name": "Test 4 - Resilience: Query Non-Existent Order (404)",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"// Generate a random orderId that doesn't exist",
							"function generateHexId(length) {",
							"    let result = '';",
							"    const characters = '0123456789ABCDEF';",
							"    for (let i = 0; i < length; i++) {",
							"        result += characters.charAt(Math.floor(Math.random() * characters.length));",
							"    }",
							"    return result;",
							"}",
							"pm.environment.set(\"nonexistent_order_id\", generateHexId(16));"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Consumer returns 404 Not Found\", () => {",
							"    pm.response.to.have.status(404);",
							"});",
							"",
							"pm.test(\"Error message indicates order not found\", () => {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData.error).to.eql(\"Not Found\");",
							"    pm.expect(jsonData.message).to.include(\"not found\");",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"orderId\": \"{{nonexistent_order_id}}\"\n}"
				},
				"url": {
					"raw": "{{base_url_consumer}}/order-details",
					"host": ["{{base_url_consumer}}"],
					"path": ["order-details"]
				},
				"description": "Test resilience: Query a non-existent orderId. Consumer should return 404 Not Found."
			},
			"response": []
		},
		{
			"name": "Test 5 - Diagnostic: Verify Order in Topic",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Consumer returns all orders from topic (200 OK)\", () => {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"Topic contains our test orderId\", () => {",
							"    const jsonData = pm.response.json();",
							"    pm.expect(jsonData.orderIds).to.include(pm.environment.get(\"test_order_id_idempotency\"));",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"topicName\": \"orders\"\n}"
				},
				"url": {
					"raw": "{{base_url_consumer}}/getAllOrdersFromTopic",
					"host": ["{{base_url_consumer}}"],
					"path": ["getAllOrdersFromTopic"]
				},
				"description": "Diagnostic check: Verify the test orderId exists in the topic. This validates end-to-end message flow."
			},
			"response": []
		}
	]
}
