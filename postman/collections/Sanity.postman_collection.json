{
	"info": {
		"_postman_id": "b736734c-2234-4532-8452-123456789abc",
		"name": "Sanity",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Request 1: Health Check (Consumer)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status code is 200\", () => pm.response.to.have.status(200));",
							"pm.test(\"Kafka connection is UP\", () => {",
							    "const jsonData = pm.response.json();",
							    "const kafkaCheck = jsonData.checks.kafka;",
							    "pm.expect(kafkaCheck.status).to.eql(\"UP\");",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [],
				"url": {
					"raw": "{{base_url_consumer}}/health/ready",
					"host": [
						"{{base_url_consumer}}"
					],
					"path": [
						"health",
						"ready"
					]
				},
				"description": "Checks if the Consumer and its Kafka connection are up."
			},
			"response": []
		},
		{
			"name": "Request 2: Create Order (Producer)",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"function generateHexId(length) {",
							    "let result = '';",
							    "const characters = '0123456789ABCDEF';",
							    "const charactersLength = characters.length;",
							    "for (let i = 0; i < length; i++) {",
							        "result += characters.charAt(Math.floor(Math.random() * charactersLength));",
							    "}",
							    "return result;",
							"}",
							"// Generate a random 16-character hex ID",
							"pm.environment.set(\"order_id\", generateHexId(16));"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Order Created successfully (201)\", () => pm.response.to.have.status(201));",
							"pm.test(\"Returns valid OrderID\", () => {",
							    "const jsonData = pm.response.json();",
							    "pm.expect(jsonData.order.orderId).to.eql(pm.environment.get(\"order_id\"));",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"orderId\": \"{{order_id}}\",\n    \"numItems\": 5\n}"
				},
				"url": {
					"raw": "{{base_url_producer}}/create-order",
					"host": [
						"{{base_url_producer}}"
					],
					"path": [
						"create-order"
					]
				}
			},
			"response": []
		},
		{
			"name": "Request 3: Get Order Details - Initial State (Consumer)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status code is 200\", () => pm.response.to.have.status(200));",
							"pm.test(\"Shipping cost is calculated\", () => {",
							    "const jsonData = pm.response.json();",
							    "// shippingCost is a string formatted as \"%.2f\"",
							    "pm.expect(parseFloat(jsonData.shippingCost)).to.be.above(0);",
							    "pm.expect(jsonData.status).to.eql(\"CREATED\");",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"orderId\": \"{{order_id}}\"\n}"
				},
				"url": {
					"raw": "{{base_url_consumer}}/order-details",
					"host": [
						"{{base_url_consumer}}"
					],
					"path": [
						"order-details"
					]
				},
				"description": "Verify the Consumer mirrored the \"CREATED\" state and calculated shipping."
			},
			"response": []
		},
		{
			"name": "Request 4: Update Order Status (Producer)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Update accepted by Producer\", () => pm.response.to.have.status(200));"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "PUT",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"orderId\": \"{{order_id}}\",\n    \"status\": \"DISPATCHED\"\n}"
				},
				"url": {
					"raw": "{{base_url_producer}}/update-order",
					"host": [
						"{{base_url_producer}}"
					],
					"path": [
						"update-order"
					]
				}
			},
			"response": []
		},
		{
			"name": "Request 5: Verify Sequential Update (Consumer)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Consumer reflected DISPATCHED status\", () => {",
							    "const jsonData = pm.response.json();",
							    "pm.expect(jsonData.status).to.eql(\"DISPATCHED\");",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"orderId\": \"{{order_id}}\"\n}"
				},
				"url": {
					"raw": "{{base_url_consumer}}/order-details",
					"host": [
						"{{base_url_consumer}}"
					],
					"path": [
						"order-details"
					]
				},
				"description": "Ensure the consumer updated the state to \"DISPATCHED\" via Kafka."
			},
			"response": []
		},
		{
			"name": "Request 6: Resilience - Invalid Transition (Producer/Consumer)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Depending on implementation, Producer might accept it,",
							"// but Consumer must NOT overwrite the state.",
							"pm.test(\"Verification: Consumer ignored old status\", () => {",
							    "const orderId = pm.environment.get(\"order_id\");",
							    "const consumerUrl = pm.environment.get(\"base_url_consumer\") + \"/order-details\";",
							    "const payload = {",
							        "mode: 'raw',",
							        "raw: JSON.stringify({ \"orderId\": orderId })",
							    "};",
							    " ",
							    "pm.sendRequest({",
							        "url: consumerUrl,",
							        "method: 'POST',",
							        "header: { 'Content-Type': 'application/json' },",
							        "body: payload",
							    "}, (err, res) => {",
							        "if (err) {",
							            "console.log(err);",
							        "}",
							        "pm.expect(res.json().status).to.eql(\"DISPATCHED\");",
							    "});",
							"});"
							],
							"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "PUT",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"orderId\": \"{{order_id}}\",\n    \"status\": \"CREATED\"\n}"
				},
				"url": {
					"raw": "{{base_url_producer}}/update-order",
					"host": [
						"{{base_url_producer}}"
					],
					"path": [
						"update-order"
					]
				},
				"description": "Try to move backward from DISPATCHED to CREATED."
			},
			"response": []
		},
		{
			"name": "Request 7: Diagnostic Check (Consumer)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Topic contains our OrderID\", () => {",
							    "const jsonData = pm.response.json();",
							    "pm.expect(jsonData.orderIds).to.include(pm.environment.get(\"order_id\"));",
							"});"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"topicName\": \"orders\"\n}"
				},
				"url": {
					"raw": "{{base_url_consumer}}/getAllOrdersFromTopic",
					"host": [
						"{{base_url_consumer}}"
					],
					"path": [
						"getAllOrdersFromTopic"
					]
				}
			},
			"response": []
		}
	]
}
